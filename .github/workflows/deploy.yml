# 워크플로우 이름
name: Deploy Flobank API and AP Servers

# 실행 시점: main 브랜치에 push가 발생할 때 실행
on:
  push:
    branches: [ main ] # (만약 브랜치 이름이 master라면 [ master ] 로 수정하세요)

# 실행될 작업들
jobs:
  # 1. 빌드 작업: 두 프로젝트를 모두 빌드
  build:
    runs-on: ubuntu-latest # 빌드 환경 (GitHub 제공)
    steps:
    - name: 1. 코드 체크아웃
      uses: actions/checkout@v4

    - name: 2. JDK 21 설치
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: 3. flobank-api 빌드 (Gradle)
      run: |
        cd flobank-api
        chmod +x ./gradlew
        ./gradlew build

    - name: 4. flobank-ap 빌드 (Gradle)
      run: |
        cd flobank-ap
        chmod +x ./gradlew
        ./gradlew build
        
    - name: 5. API 서버 아티팩트(빌드 파일) 업로드
      uses: actions/upload-artifact@v4
      with:
        name: api-jar # 아티팩트 이름 (임시 저장)
        path: flobank-api/build/libs/*.jar # 빌드된 .jar 파일 경로

    - name: 6. AP 서버 아티팩트(빌드 파일) 업로드
      uses: actions/upload-artifact@v4
      with:
        name: ap-jar # 아티팩트 이름 (임시 저장)
        path: flobank-ap/build/libs/*.jar # 빌드된 .jar 파일 경로

  # 2. API 서버 배포 작업
  deploy-api:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: 1. API 서버 아티팩트 다운로드
      uses: actions/download-artifact@v4
      with:
        name: api-jar

    - name: 2. API 서버에 배포 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.API_SERVER_HOST }}
        username: ${{ secrets.API_SERVER_USER }}
        key: ${{ secrets.API_SERVER_KEY }}
        script: |
          pkill -f 'flobank-api.jar' || true
          
          # [수정] ubuntu -> mjgemini987 로 변경
          mkdir -p /home/mjgemini987/api
          mv ./*.jar /home/mjgemini987/api/flobank-api.jar
          
          # [수정] ubuntu -> mjgemini987 로 변경
          cd /home/mjgemini987/api
          nohup java -jar -Dspring.profiles.active=prod flobank-api.jar > api.log 2>&1 &
          
  # 3. AP 서버 배포 작업
  deploy-ap:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: 1. AP 서버 아티팩트 다운로드
      uses: actions/download-artifact@v4
      with:
        name: ap-jar

    - name: 2. AP 서버에 배포 (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AP_SERVER_HOST }}
        username: ${{ secrets.AP_SERVER_USER }}
        key: ${{ secrets.AP_SERVER_KEY }}
        script: |
          pkill -f 'flobank-ap.jar' || true
          
          # [수정] ubuntu -> mjgemini987 로 변경
          mkdir -p /home/mjgemini987/ap
          mv ./*.jar /home/mjgemini987/ap/flobank-ap.jar
          
          # [수정] ubuntu -> mjgemini987 로 변경
          cd /home/mjgemini987/ap
          nohup java -jar -Dspring.profiles.active=prod flobank-ap.jar > ap.log 2>&1 &
