# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Deploy Flobank API and AP Servers

# ì‹¤í–‰ ì‹œì : main ë¸Œëžœì¹˜ì— pushê°€ ë°œìƒí•  ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ main ] # (ë§Œì•½ ë¸Œëžœì¹˜ ì´ë¦„ì´ masterë¼ë©´ [ master ] ë¡œ ìˆ˜ì •í•˜ì„¸ìš”)

# ì‹¤í–‰ë  ìž‘ì—…ë“¤
jobs:
  # 1. ë¹Œë“œ ìž‘ì—…: ë‘ í”„ë¡œì íŠ¸ë¥¼ ëª¨ë‘ ë¹Œë“œ
  build:
    runs-on: ubuntu-latest # ë¹Œë“œ í™˜ê²½ (GitHub ì œê³µ)
    steps:
    - name: 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: 2. JDK 21 ì„¤ì¹˜
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: 3. flobank-api ë¹Œë“œ (Gradle)
      run: |
        cd flobank-api
        chmod +x ./gradlew
        ./gradlew build

    - name: 4. flobank-ap ë¹Œë“œ (Gradle)
      run: |
        cd flobank-ap
        chmod +x ./gradlew
        ./gradlew build
        
    - name: 5. API ì„œë²„ ì•„í‹°íŒ©íŠ¸(ë¹Œë“œ íŒŒì¼) ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: api-jar # ì•„í‹°íŒ©íŠ¸ ì´ë¦„ (ìž„ì‹œ ì €ìž¥)
        path: flobank-api/build/libs/*.jar # ë¹Œë“œëœ .jar íŒŒì¼ ê²½ë¡œ

    - name: 6. AP ì„œë²„ ì•„í‹°íŒ©íŠ¸(ë¹Œë“œ íŒŒì¼) ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ap-jar # ì•„í‹°íŒ©íŠ¸ ì´ë¦„ (ìž„ì‹œ ì €ìž¥)
        path: flobank-ap/build/libs/*.jar # ë¹Œë“œëœ .jar íŒŒì¼ ê²½ë¡œ

  # 2. API ì„œë²„ ë°°í¬ ìž‘ì—…
  deploy-api:
    needs: build # build ìž‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
    - name: 1. API ì„œë²„ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: api-jar # buildì—ì„œ ì—…ë¡œë“œí•œ ì´ë¦„

    - name: 2. API ì„œë²„ì— ë°°í¬ (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.API_SERVER_HOST }}     # GitHub Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°
        username: ${{ secrets.API_SERVER_USER }} # GitHub Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°
        key: ${{ secrets.API_SERVER_KEY }}      # GitHub Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°
        script: |
          pkill -f 'flobank-api.jar' || true
          mkdir -p /home/mjgemini987/api
          mv ./*.jar /home/mjgemini987/api/flobank-api.jar
          cd /home/mjgemini987/api
          nohup java -jar -Dspring.profiles.active=prod flobank-api.jar > api.log 2>&1 &
          
  # 3. AP ì„œë²„ ë°°í¬ ìž‘ì—…
  deploy-ap:
    needs: build # build ìž‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
    - name: 1. AP ì„œë²„ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: ap-jar # buildì—ì„œ ì—…ë¡œë“œí•œ ì´ë¦„

    - name: 2. AP ì„œë²„ì— ë°°í¬ (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AP_SERVER_HOST }}     # GitHub Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°
        username: ${{ secrets.AP_SERVER_USER }} # GitHub Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°
        key: ${{ secrets.AP_SERVER_KEY }}      # GitHub Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°
        script: |
          pkill -f 'flobank-ap.jar' || true
          mkdir -p /home/mjgemini987/ap   # ðŸ‘ˆ ubuntuì—ì„œ mjgemini987ë¡œ ìˆ˜ì •
          mv ./*.jar /home/mjgemini987/ap/flobank-ap.jar
          cd /home/mjgemini987/ap
          nohup java -jar -Dspring.profiles.active=prod flobank-ap.jar > ap.log 2>&1 &